version: 3

env:
  UID:
    sh: id -u
  GID:
    sh: id -g
  PHP_VERSION: '{{ .PHP_VERSION | default "8.3" }}'

tasks:
  default:
    cmds:
      - cmd: task -l
        silent: true

  docker:build:
    desc: Build the PHP test container
    cmds:
      - sed 's/{MYVERSION}/PHP8_1/g' phpunit.dist.xml > phpunit.xml
      - docker compose build --pull

  docker:remove:
    desc: Remove PHP test container
    cmds:
      - docker compose down --volumes

  docker:shell:
    desc: Connect to test container
    deps:
      - docker:build
    cmds:
      - docker compose run php bash

  tests:
    desc: Execute PHPUnit tests
    deps:
      - docker:build
    cmds:
      - docker compose run php ./vendor/bin/phpunit --testsuite "Alma PHP Client Unit Test Suite"

  tests:integration:
    desc: Execute intregration tests
    deps:
      - docker:build
    cmds:
      - docker compose run php ./vendor/bin/phpunit --testsuite "Alma PHP Client Integration Test Suite"

  lint:
    desc: Lint the php code
    deps:
      - docker:build
    cmds:
      - docker compose run php ./vendor/bin/phpcs src/

  lint:fix:
    desc: Lint fix the php code
    deps:
      - docker:build
    cmds:
      - docker compose run php ./vendor/bin/phpcbf src/ tests/

  build:
    desc: Build zip dist package using Docker
    deps:
      - docker:build
    cmds:
      - docker compose run php ./build.sh
